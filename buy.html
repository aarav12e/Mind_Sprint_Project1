<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Buy — Mind Sprint</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body{ background:#f3f4f6; font-family:Segoe UI, Arial, sans-serif }
    main { max-width:900px; margin:36px auto; padding:18px; background:#fff; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.06); }
    h1{ color:#111827; margin-bottom:6px }
    .product { display:flex; gap:20px; align-items:flex-start }
    .product img{ width:160px; height:160px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb }
    .product-info{ flex:1 }
    label{ display:block; margin:8px 0 6px; font-weight:600; color:#374151 }
    input[type="text"], input[type="tel"], input[type="number"], textarea, select { width:100%; padding:10px; border-radius:6px; border:1px solid #e5e7eb; background:#ffffff }
    .row{ display:flex; gap:12px }
    .col{ flex:1 }
    .small{ max-width:180px }
    .btn{ padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:700 }
    .btn-primary{ background:#0ea5a4; color:#fff }
    .summary{ border-left:1px solid #f3f4f6; padding-left:18px }
    .muted{ color:#6b7280; font-size:13px }
    .success{ background:#ecfdf5; color:#065f46; padding:10px 12px; border-radius:8px; display:inline-block }
  </style>
</head>
<body>
  <main>
    <h1>Buy Now</h1>
    <p class="muted">This page is for buyers. Review product, enter shipping details, choose payment and place the order.</p>

    <div style="display:flex; gap:24px; margin-top:18px; align-items:flex-start">
      <div style="flex:2">
        <div class="product">
            <img id="prod-img" src="res/banana.jpg" alt="product">
          <div class="product-info">
            <h2 id="prod-name">Product name</h2>
            <div style="margin:6px 0; font-weight:700; font-size:18px">₹ <span id="prod-price">0.00</span></div>
            <div class="muted">Seller: Mind Sprint</div>
            <p id="prod-desc" class="muted" style="margin-top:10px">Short product description will appear here.</p>

            <div id="cart-items" style="margin-top:12px"></div>

            <div id="single-qty" style="margin-top:12px; display:flex; gap:8px; align-items:center;">
              <label style="margin:0">Quantity</label>
              <input id="quantity" type="number" min="1" value="1" style="width:90px; padding:8px; border-radius:6px; border:1px solid #e5e7eb">
            </div>
          </div>
        </div>

        <section style="margin-top:18px">
          <h3 style="margin:0 0 8px 0">Shipping Address</h3>
          <label for="cust-name">Full name *</label>
          <input id="cust-name" type="text" placeholder="Your name">

          <div class="row" style="margin-top:8px">
            <div class="col small">
              <label for="cust-mobile">Mobile *</label>
              <input id="cust-mobile" type="tel" placeholder="9876543210">
            </div>
            <div class="col small">
              <label for="cust-pincode">Pincode *</label>
              <input id="cust-pincode" type="text" placeholder="110001">
            </div>
          </div>

          <label for="cust-address">Address *</label>
          <textarea id="cust-address" rows="3" placeholder="House no, Street, Area"></textarea>
        </section>

        <section style="margin-top:16px">
          <h3 style="margin:0 0 8px 0">Payment</h3>
          <select id="payment-mode">
            <option value="prepaid">Prepaid (Card / UPI)</option>
            <option value="cod">Cash on Delivery</option>
          </select>
        </section>

        <div style="margin-top:16px; display:flex; gap:8px;">
          <button class="btn btn-primary" onclick="placeOrder()">Place Order</button>
          <button class="btn" onclick="saveDraft()" style="border:1px solid #d1d5db">Save as Draft</button>
        </div>
      </div>

      <aside class="summary" style="flex:1">
        <h3 style="margin-top:0">Order Summary</h3>
        <div style="display:flex; justify-content:space-between; margin-top:8px"><div>Price</div><div>₹ <span id="sum-price">0.00</span></div></div>
        <div style="display:flex; justify-content:space-between; margin-top:6px"><div>Qty</div><div id="sum-qty">1</div></div>
        <hr style="margin:12px 0">
        <div style="display:flex; justify-content:space-between; font-weight:700"><div>Total</div><div>₹ <span id="sum-total">0.00</span></div></div>

        <div style="margin-top:14px">
          <div id="order-result"></div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px">
          <button class="btn" onclick="toggleOrdersPanel()" style="border:1px solid #d1d5db">View Orders</button>
        </div>
        <div id="orders-panel" style="display:none; margin-top:12px;">
          <h4 style="margin:6px 0">Your Orders</h4>
          <div style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
            <input id="orders-search" type="text" placeholder="Search orders by ID, product, name or phone" style="flex:1; padding:8px; border-radius:6px; border:1px solid #e5e7eb">
            <button class="btn" onclick="document.getElementById('orders-search').value=''; renderOrders();" title="Clear">Clear</button>
          </div>
          <div id="orders-list" style="max-height:300px; overflow:auto; border:1px solid #eef2f7; padding:8px; border-radius:8px; background:#fafafc"></div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // Small buyer-focused script (supports single item and cart checkout)
    function fmt(n){ return Number(n||0).toFixed(2); }

    // Generate a unique alphanumeric ID (letters + digits) and ensure no collision with stored orders
    function generateUniqueId(prefix, length = 8){
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      const orders = JSON.parse(localStorage.getItem('orders')||'[]');
      const existing = new Set((orders||[]).map(o => o.id));
      let attempt = 0;
      while(attempt < 1000){
        let id = '';
        for(let i=0;i<length;i++) id += chars[Math.floor(Math.random()*chars.length)];
        const candidate = prefix + '-' + id;
        if(!existing.has(candidate)) return candidate;
        attempt++;
      }
      // fallback
      return prefix + '-' + Math.random().toString(36).substr(2,8).toUpperCase();
    }

    // Update order summary: supports buyCart (multi-item) and buyProduct (single)
    function updateSummary(){
      const buyCart = JSON.parse(localStorage.getItem('buyCart')||'null');
      if(buyCart && Array.isArray(buyCart) && buyCart.length){
        const total = buyCart.reduce((s,i)=> s + (Number(i.price)||0) * (Number(i.quantity)||1), 0);
        const qty = buyCart.reduce((s,i)=> s + (Number(i.quantity)||1), 0);
        document.getElementById('sum-price').innerText = fmt(total);
        document.getElementById('sum-qty').innerText = qty;
        document.getElementById('sum-total').innerText = fmt(total);
        // reflect in product price display
        document.getElementById('prod-price').innerText = fmt(total);
        document.getElementById('prod-price').dataset.value = total;
        // hide single quantity control for cart checkout
        const singleQty = document.getElementById('single-qty'); if(singleQty) singleQty.style.display = 'none';
        return;
      }

      const price = Number(document.getElementById('prod-price').dataset.value||0);
      const qty = Number(document.getElementById('quantity').value||1);
      document.getElementById('sum-price').innerText = fmt(price);
      document.getElementById('sum-qty').innerText = qty;
      document.getElementById('sum-total').innerText = fmt(price*qty);
    }

    document.getElementById('quantity').addEventListener('input', updateSummary);

    // Place order: supports multi-item cart or single product
    function placeOrder(){
      const name = document.getElementById('cust-name').value.trim();
      const phone = document.getElementById('cust-mobile').value.trim();
      const pincode = document.getElementById('cust-pincode').value.trim();
      const address = document.getElementById('cust-address').value.trim();
      const payment = document.getElementById('payment-mode').value;

      if(!name || !phone || !pincode || !address){ alert('Please fill shipping details'); return; }
      if(!/^[0-9]{10}$/.test(phone)){ alert('Enter valid 10 digit mobile number'); return; }

      const buyCart = JSON.parse(localStorage.getItem('buyCart')||'null');
      let order = null;

      if(buyCart && Array.isArray(buyCart) && buyCart.length){
        // Build order with items array (include image when available)
        const items = buyCart.map(i => ({ id: i.id, name: i.name, price: Number(i.price)||0, qty: Number(i.quantity)||1, total: (Number(i.price)||0)*(Number(i.quantity)||1), image: (i.image || i.img || '') }));
        const total = items.reduce((s,it)=> s + it.total, 0);
        order = {
          id: generateUniqueId('ORD',8),
          items,
          total,
          customer:{ name, phone, pincode, address },
          payment, createdAt: new Date().toISOString(),
          trackingId: generateUniqueId('TRK',10),
          status: 'placed'
        };
        // Save order
        const orders = JSON.parse(localStorage.getItem('orders')||'[]');
        orders.push(order);
        localStorage.setItem('orders', JSON.stringify(orders));
        // cleanup
        localStorage.removeItem('buyCart');
      } else {
        // single product flow
        const qty = Number(document.getElementById('quantity').value||1);
        const price = Number(document.getElementById('prod-price').dataset.value||0);
        order = {
          id: generateUniqueId('ORD',8),
          product: document.getElementById('prod-name').innerText,
          productImage: document.getElementById('prod-img').src,
          qty, price, total: price*qty,
          customer:{ name, phone, pincode, address },
          payment, createdAt: new Date().toISOString(),
          trackingId: generateUniqueId('TRK',10),
          status: 'placed'
        };
        const orders = JSON.parse(localStorage.getItem('orders')||'[]');
        orders.push(order);
        localStorage.setItem('orders', JSON.stringify(orders));
        try{ localStorage.removeItem('buyProduct'); }catch(e){}
      }

      const result = document.getElementById('order-result');
      if(order){
        result.innerHTML = '<div class="success">Order placed — <strong>'+order.id+'</strong><br>Tracking: <em>'+order.trackingId+'</em></div>';
      }

      try{ localStorage.removeItem('orderDraft'); }catch(e){}
      updateSummary();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function saveDraft(){
      const buyCart = JSON.parse(localStorage.getItem('buyCart')||'null');
      const draft = {
        name: document.getElementById('cust-name').value,
        phone: document.getElementById('cust-mobile').value,
        address: document.getElementById('cust-address').value,
        product: document.getElementById('prod-name').innerText,
        qty: document.getElementById('quantity').value,
        items: buyCart || null
      };
      localStorage.setItem('orderDraft', JSON.stringify(draft));
      alert('Saved draft');
    }

    // Simple pincode -> area lookup for demo autopopulate
    const pincodeMap = {
      '110001': 'Connaught Place, New Delhi',
      '560001': 'Bengaluru GPO, Bangalore',
      '400001': 'Fort, Mumbai'
    };

    const pincodeInput = document.getElementById('cust-pincode');
    if(pincodeInput){
      pincodeInput.addEventListener('input', function(){
        const v = this.value.trim();
        if(v.length >= 6 && pincodeMap[v]){
          const addrEl = document.getElementById('cust-address');
          // only auto-fill if address is empty or looks like a previous suggestion
          if(addrEl && (!addrEl.value || addrEl.value.trim().length < 10)){
            addrEl.value = pincodeMap[v] + ', ' + addrEl.value;
          }
        }
      });
    }

    // Prefill product(s) and buyer info if available
    document.addEventListener('DOMContentLoaded', function(){
      try{
        // Prefer buyCart (multi-item) when present
        const bc = JSON.parse(localStorage.getItem('buyCart')||'null');
        if(bc && Array.isArray(bc) && bc.length){
          // render items list
          const itemsEl = document.getElementById('cart-items');
          itemsEl.innerHTML = '<h4 style="margin:6px 0">Items in cart</h4>';
          let total = 0; let qty = 0;
          const ul = document.createElement('div');
          ul.style.display = 'grid'; ul.style.gap = '8px';
          bc.forEach(it => {
            const row = document.createElement('div');
            row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center';
            row.innerHTML = `<div style="font-weight:700">${it.name}</div><div class="muted">₹${fmt(it.price)} x ${it.quantity}</div>`;
            ul.appendChild(row);
            total += (Number(it.price)||0) * (Number(it.quantity)||1);
            qty += Number(it.quantity)||1;
          });
          itemsEl.appendChild(ul);
          document.getElementById('prod-name').innerText = 'Cart — '+bc.length+' items';
          document.getElementById('prod-desc').innerText = 'Review items and enter shipping details to place a single order for the cart.';
          if(bc[0] && (bc[0].image || bc[0].img)) document.getElementById('prod-img').src = (bc[0].image || bc[0].img);
          document.getElementById('prod-price').innerText = fmt(total);
          document.getElementById('prod-price').dataset.value = total;
        } else {
          // Product from storage (single buy) fallback
          const bp = localStorage.getItem('buyProduct');
          if(bp){ const p = JSON.parse(bp); document.getElementById('prod-name').innerText = p.name||'Product name'; document.getElementById('prod-price').innerText = fmt(p.price||0); document.getElementById('prod-price').dataset.value = p.price||0; if(p.desc) document.getElementById('prod-desc').innerText = p.desc; if(p.img || p.image) document.getElementById('prod-img').src = (p.img || p.image); if(p.quantity) document.getElementById('quantity').value = p.quantity; }
        }

        // draft or user info
        const draft = JSON.parse(localStorage.getItem('orderDraft')||'null');
        if(draft){ if(draft.name) document.getElementById('cust-name').value = draft.name; if(draft.phone) document.getElementById('cust-mobile').value = draft.phone; if(draft.address) document.getElementById('cust-address').value = draft.address; if(draft.qty) document.getElementById('quantity').value = draft.qty; }

        // default price dataset if none
        if(!document.getElementById('prod-price').dataset.value) document.getElementById('prod-price').dataset.value = Number(document.getElementById('prod-price').innerText||0);
      }catch(e){ console.error(e); }
      updateSummary();
      // prepare orders panel
      renderOrders();
    });

    function toggleOrdersPanel(){
      const panel = document.getElementById('orders-panel');
      if(!panel) return;
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      if(panel.style.display === 'block') renderOrders();
    }

    // Re-render orders as user types in search
    document.addEventListener('input', function(e){
      if(e.target && e.target.id === 'orders-search') renderOrders();
    });

    function renderOrders(){
      const listEl = document.getElementById('orders-list');
      if(!listEl) return;
      const allOrders = JSON.parse(localStorage.getItem('orders')||'[]').slice().reverse();
      const query = (document.getElementById('orders-search')?.value||'').trim().toLowerCase();
      let orders = allOrders;
      if(query){
        orders = allOrders.filter(o => {
          const id = (o.id||'').toLowerCase();
          const product = ((o.product || (o.items && o.items.map(it=>it.name).join(', ')))||'').toLowerCase();
          const name = ((o.customer && o.customer.name) || '').toLowerCase();
          const phone = ((o.customer && o.customer.phone) || '').toLowerCase();
          const tracking = (o.trackingId||'').toLowerCase();
          return id.includes(query) || product.includes(query) || name.includes(query) || phone.includes(query) || tracking.includes(query);
        });
      }
      if(orders.length === 0){ listEl.innerHTML = '<div class="muted">No orders match your search.</div>'; return; }

      listEl.innerHTML = '';
      orders.forEach(o => {
        const item = document.createElement('div');
        item.style.padding = '8px';
        item.style.borderBottom = '1px solid #eef2f7';
        item.style.display = 'flex';
        item.style.justifyContent = 'space-between';
        item.style.alignItems = 'center';

        const left = document.createElement('div');
        left.style.display = 'flex'; left.style.gap = '10px'; left.style.alignItems = 'center';
        // thumbnail
        const thumb = document.createElement('img');
        thumb.style.width = '56px'; thumb.style.height = '56px'; thumb.style.objectFit = 'cover'; thumb.style.borderRadius = '6px';
        if(o.items && o.items.length){ thumb.src = o.items[0].image || ''; } else { thumb.src = o.productImage || ''; }
        thumb.onerror = ()=> thumb.style.display = 'none';

        const productSummary = document.createElement('div');
        const prodText = o.product ? (o.product+' — ₹'+(Number(o.price||o.total||0).toFixed(2))) : ((o.items && o.items.map(it=>it.name+' x'+it.qty).join(', ')) || '');
        productSummary.innerHTML = '<div style="font-weight:700">'+o.id+' <span style="font-size:12px; color:#6b7280; font-weight:600; margin-left:8px;">'+(o.status||'')+'</span></div><div class="muted">'+prodText+'</div>';

        left.appendChild(thumb);
        left.appendChild(productSummary);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.gap = '8px';

        const detailsBtn = document.createElement('button');
        detailsBtn.className = 'btn';
        detailsBtn.style.border = '1px solid #d1d5db';
        detailsBtn.innerText = 'Details';
        detailsBtn.onclick = ()=> showOrderDetails(o.id);

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn';
        if(o.status === 'cancelled'){
          cancelBtn.style.background = '#9ca3af';
          cancelBtn.style.color = '#fff';
          cancelBtn.innerText = 'Cancelled';
          cancelBtn.disabled = true;
        } else {
          cancelBtn.style.background = '#ef4444';
          cancelBtn.style.color = '#fff';
          cancelBtn.innerText = 'Cancel';
          cancelBtn.onclick = ()=> cancelOrder(o.id);
        }

        right.appendChild(detailsBtn);
        right.appendChild(cancelBtn);

        item.appendChild(left);
        item.appendChild(right);
        listEl.appendChild(item);
      });
    }

    function showOrderDetails(id){
      const orders = JSON.parse(localStorage.getItem('orders')||'[]');
      const o = orders.find(x => x.id === id);
      if(!o) { alert('Order not found'); return; }
      // build modal
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed'; overlay.style.left = 0; overlay.style.top = 0; overlay.style.right = 0; overlay.style.bottom = 0;
      overlay.style.background = 'rgba(0,0,0,0.5)'; overlay.style.display = 'flex'; overlay.style.alignItems = 'center'; overlay.style.justifyContent = 'center';
      overlay.style.zIndex = 9999;

      const box = document.createElement('div');
      box.style.width = '720px'; box.style.maxWidth = '95%'; box.style.background = '#fff'; box.style.borderRadius = '10px'; box.style.padding = '18px'; box.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';

      const title = document.createElement('h3'); title.innerText = 'Order ' + o.id; title.style.marginTop = '0';
      box.appendChild(title);

      const status = document.createElement('div'); status.innerHTML = '<strong>Status:</strong> ' + (o.status||'placed'); status.style.marginBottom = '8px';
      box.appendChild(status);

      const content = document.createElement('div');

      if(o.items && o.items.length){
        const itemList = document.createElement('div'); itemList.style.display = 'grid'; itemList.style.gap = '10px';
        o.items.forEach(it => {
          const r = document.createElement('div'); r.style.display = 'flex'; r.style.alignItems = 'center'; r.style.gap = '12px';
          const img = document.createElement('img'); img.src = it.image || ''; img.alt = it.name; img.style.width = '64px'; img.style.height = '64px'; img.style.objectFit = 'cover'; img.style.borderRadius = '6px'; img.onerror = ()=> img.style.display='none';
          const meta = document.createElement('div'); meta.innerHTML = '<div style="font-weight:700">'+it.name+'</div><div class="muted">₹'+fmt(it.price)+' x '+it.qty+' = ₹'+fmt(it.total)+'</div>';
          r.appendChild(img); r.appendChild(meta);
          itemList.appendChild(r);
        });
        content.appendChild(itemList);
        const tot = document.createElement('div'); tot.style.marginTop = '10px'; tot.style.fontWeight = '700'; tot.innerText = 'Total: ₹' + fmt(o.total);
        content.appendChild(tot);
      } else {
        const r = document.createElement('div'); r.style.display = 'flex'; r.style.alignItems = 'center'; r.style.gap = '12px';
        const img = document.createElement('img'); img.src = o.productImage || ''; img.alt = o.product || ''; img.style.width = '96px'; img.style.height = '96px'; img.style.objectFit = 'cover'; img.style.borderRadius = '6px'; img.onerror = ()=> img.style.display='none';
        const meta = document.createElement('div'); meta.innerHTML = '<div style="font-weight:700">'+(o.product||'')+'</div><div class="muted">₹'+fmt(o.price || o.total||0) + ' x '+(o.qty||1)+'</div>';
        r.appendChild(img); r.appendChild(meta);
        content.appendChild(r);
      }

      const cust = document.createElement('div'); cust.style.marginTop = '12px'; cust.innerHTML = '<div style="font-weight:700">Customer</div><div>'+ (o.customer?.name||'') + ' — ' + (o.customer?.phone||'') + '</div><div class="muted">'+(o.customer?.address||'')+' ('+(o.customer?.pincode||'')+')</div>';
      content.appendChild(cust);

      const trace = document.createElement('div'); trace.style.marginTop = '8px'; trace.innerHTML = '<div class="muted">Placed: '+(new Date(o.createdAt).toLocaleString())+'</div><div class="muted">Tracking: '+(o.trackingId||'')+'</div>';
      content.appendChild(trace);

      box.appendChild(content);

      const closeRow = document.createElement('div'); closeRow.style.display = 'flex'; closeRow.style.justifyContent = 'flex-end'; closeRow.style.marginTop = '12px';
      const closeBtn = document.createElement('button'); closeBtn.className = 'btn'; closeBtn.innerText = 'Close'; closeBtn.onclick = ()=> overlay.remove();
      closeRow.appendChild(closeBtn);
      box.appendChild(closeRow);

      overlay.appendChild(box);
      document.body.appendChild(overlay);
    }

    function cancelOrder(id){
      if(!confirm('Cancel order '+id+'?')) return;
      const orders = JSON.parse(localStorage.getItem('orders')||'[]');
      const idx = orders.findIndex(x => x.id === id);
      if(idx === -1) { alert('Order not found'); return; }
      // mark as cancelled instead of deleting
      orders[idx].status = 'cancelled';
      orders[idx].cancelledAt = new Date().toISOString();
      localStorage.setItem('orders', JSON.stringify(orders));
      renderOrders();
      const res = document.getElementById('order-result'); if(res) res.innerHTML = '<div style="color:#b91c1c; font-weight:700">Order '+id+' marked cancelled</div>';
    }
  </script>
</body>
</html>